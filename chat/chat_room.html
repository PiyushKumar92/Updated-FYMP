{% extends "base.html" %}

{% block title %}Chat with {{ room.user.username if current_user.is_admin else room.admin.username }} - Missing Person Finder{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <div class="col-12">
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-header-left">
                        <a href="{{ url_for('main.chat_list') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div class="chat-avatar">
                            {% if current_user.is_admin %}
                                {{ room.user.username[0].upper() }}
                            {% else %}
                                {{ room.admin.username[0].upper() }}
                            {% endif %}
                        </div>
                        <div class="chat-user-info">
                            <h6>
                                {% if current_user.is_admin %}
                                    {{ room.user.username }}
                                {% else %}
                                    {{ room.admin.username }}
                                {% endif %}
                            </h6>
                            <small>
                                {% if current_user.is_admin %}
                                    Member since {{ room.user.created_at.strftime('%B %Y') }}
                                {% else %}
                                    Support Team • Always here to help
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-outline-danger btn-sm" onclick="clearChatHistory()" title="Clear Chat History">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="online-status" id="userStatus">
                            <i class="fas fa-circle" id="statusIcon"></i>
                            <small id="statusText">Checking...</small>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    {% for message in messages %}
                    <div class="message {{ 'message-own' if message.sender_id == current_user.id else 'message-other' }}" data-message-id="{{ message.id }}">
                        <div class="message-content">
                            {% if message.message_type == 'text' or not message.message_type %}
                                <p class="mb-1">{{ message.content }}</p>
                            {% elif message.message_type == 'image' %}
                                <div class="message-media">
                                    <img src="{{ url_for('static', filename=message.file_path) }}" 
                                         alt="Shared image" 
                                         class="chat-image"
                                         onclick="openImageModal(this.src)">
                                    {% if message.content %}
                                        <p class="mt-2 mb-1">{{ message.content }}</p>
                                    {% endif %}
                                </div>
                            {% elif message.message_type == 'video' %}
                                <div class="message-media">
                                    <video controls class="chat-video">
                                        <source src="{{ url_for('static', filename=message.file_path) }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                    {% if message.content %}
                                        <p class="mt-2 mb-1">{{ message.content }}</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="message-file">
                                    <i class="fas fa-file me-2"></i>
                                    <a href="{{ url_for('static', filename=message.file_path) }}" target="_blank">
                                        {{ message.file_name }}
                                    </a>
                                    {% if message.content %}
                                        <p class="mt-2 mb-1">{{ message.content }}</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div class="message-meta">
                                {% if message.sender_id == current_user.id %}
                                    <span class="message-status" data-status="{{ message.status }}">
                                        {% if message.status == 'sent' %}
                                            <i class="fas fa-check status-sent" style="color: #9ca3af;" title="Sent"></i>
                                        {% elif message.status == 'delivered' %}
                                            <i class="fas fa-check-double status-delivered" style="color: #9ca3af;" title="Delivered"></i>
                                        {% elif message.status == 'seen' %}
                                            <i class="fas fa-check-double status-seen" style="color: #00d4aa;" title="Seen"></i>
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Chat Input -->
                <div class="chat-input">
                    <form id="chatForm" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="input-group">
                            <input type="file" id="fileInput" accept="image/*,video/*,*" style="display: none;" onchange="handleFileSelect(this)">
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." autocomplete="off">
                            <button type="submit" class="btn btn-primary" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div id="filePreview" class="file-preview mt-2" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" alt="Full size image">
            </div>
        </div>
    </div>
</div>

<style>
/* Professional Chat Interface */
.chat-container {
    height: calc(100vh - 100px);
    display: flex;
    flex-direction: column;
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.08);
    overflow: hidden;
    border: 1px solid #e5e7eb;
    max-width: 1200px;
    margin: 0 auto;
}

/* Clean Professional Header */
.chat-header {
    padding: 1.5rem 2rem;
    background: #ffffff;
    color: #1f2937;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #e5e7eb;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.chat-header-left {
    display: flex;
    align-items: center;
    gap: 1.25rem;
}

.chat-avatar {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.25);
    border: 3px solid #ffffff;
}

.chat-user-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.chat-user-info h6 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1.2;
}

.chat-user-info small {
    color: #6b7280;
    font-size: 0.9rem;
    font-weight: 500;
    line-height: 1.3;
}

.online-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f0fdf4;
    padding: 0.625rem 1.25rem;
    border-radius: 25px;
    border: 1px solid #bbf7d0;
    transition: all 0.3s ease;
}

.online-status i {
    color: #16a34a;
    font-size: 0.75rem;
    animation: pulse 2s infinite;
    transition: color 0.3s ease;
}

.online-status small {
    color: #16a34a;
    font-weight: 600;
    font-size: 0.85rem;
    transition: color 0.3s ease;
}

.online-status.offline {
    background: #f9fafb;
    border-color: #e5e7eb;
}

.online-status.offline i {
    color: #9ca3af;
    animation: none;
}

.online-status.offline small {
    color: #6b7280;
}

/* Messages Area */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    background: #fafafa;
    position: relative;
}

.chat-messages::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 20px;
    background: linear-gradient(180deg, rgba(250,250,250,1) 0%, rgba(250,250,250,0) 100%);
    z-index: 1;
}

/* Message Bubbles */
.message {
    margin-bottom: 1.5rem;
    display: flex;
    animation: messageSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.message-own {
    animation: messageSlideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.message-other {
    animation: messageSlideInLeft 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes messageSlideInRight {
    from {
        opacity: 0;
        transform: translateX(30px) translateY(10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateX(0) translateY(0) scale(1);
    }
}

@keyframes messageSlideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px) translateY(10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateX(0) translateY(0) scale(1);
    }
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(15px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.message-own {
    justify-content: flex-end;
}

.message-other {
    justify-content: flex-start;
}

.message-content {
    max-width: 65%;
    padding: 1rem 1.25rem;
    border-radius: 20px;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.message-own .message-content {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    border-bottom-right-radius: 6px;
    box-shadow: 0 3px 12px rgba(37, 99, 235, 0.3);
    border: none;
}

.message-other .message-content {
    background: #ffffff;
    color: #1f2937;
    border: 1px solid #e5e7eb;
    border-bottom-left-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* Message Meta Information */
.message-meta {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: 0.75rem;
    gap: 0.75rem;
}

/* Status Indicators */
.message-status {
    font-size: 0.8rem;
    opacity: 0.9;
    margin-left: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.message-status .fa-check.status-sent {
    color: #9ca3af !important;
}

.message-status .fa-check-double.status-delivered {
    color: #9ca3af !important;
}

.message-status .fa-check-double.status-seen {
    color: #00d4aa !important;
}

/* Media Messages */
.message-media {
    border-radius: 12px;
    overflow: hidden;
    background: rgba(0,0,0,0.02);
}

.chat-image {
    max-width: 280px;
    max-height: 280px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.chat-image:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.chat-video {
    max-width: 320px;
    max-height: 240px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.message-file {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: rgba(59, 130, 246, 0.08);
    border-radius: 12px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    gap: 0.75rem;
    transition: all 0.2s ease;
}

.message-file:hover {
    background: rgba(59, 130, 246, 0.12);
}

.message-file i {
    color: #3b82f6;
    font-size: 1.2rem;
}

/* Professional Chat Input */
.chat-input {
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-top: 1px solid #e2e8f0;
    backdrop-filter: blur(20px);
}

.input-group {
    background: #ffffff;
    border-radius: 28px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    border: 2px solid #e5e7eb;
    overflow: hidden;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    min-height: 56px;
}

.input-group:focus-within {
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
    border-color: #3b82f6;
    transform: translateY(-2px);
}

.input-group .btn {
    border: none;
    background: transparent;
    padding: 0.875rem;
    color: #6b7280;
    transition: all 0.2s ease;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 6px;
}

.input-group .btn:hover {
    background: #f1f5f9;
    color: #3b82f6;
    transform: scale(1.05);
}

.input-group .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.input-group .btn-primary:hover {
    background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
    transform: scale(1.1) translateY(-1px);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
}

#messageInput {
    border: none;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    background: transparent;
    resize: none;
    flex: 1;
    line-height: 1.5;
    color: #1f2937;
    font-weight: 500;
}

#messageInput:focus {
    box-shadow: none;
    border: none;
    outline: none;
}

#messageInput::placeholder {
    color: #9ca3af;
    font-weight: 400;
}

/* Professional File Preview */
.file-preview {
    padding: 1rem;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(99, 102, 241, 0.05) 100%);
    border-radius: 16px;
    border: 2px solid rgba(59, 130, 246, 0.15);
    margin-top: 1rem;
    backdrop-filter: blur(10px);
    animation: slideUp 0.3s ease;
}

.file-preview img {
    max-width: 100px;
    max-height: 100px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    border: 2px solid rgba(255,255,255,0.8);
}

.file-preview .d-flex {
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    background: rgba(255,255,255,0.7);
    border-radius: 12px;
    backdrop-filter: blur(5px);
}

.file-preview .btn-outline-danger {
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border: 2px solid #ef4444;
    color: #ef4444;
    background: rgba(255,255,255,0.9);
}

.file-preview .btn-outline-danger:hover {
    background: #ef4444;
    color: white;
    transform: scale(1.1);
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideDown {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(-20px);
    }
}

/* Back Button */
.btn-outline-secondary {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    color: #64748b;
    border-radius: 12px;
    padding: 0.625rem 1rem;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-outline-secondary:hover {
    background: #e2e8f0;
    border-color: #cbd5e1;
    color: #475569;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .chat-container {
        height: calc(100vh - 60px);
        border-radius: 0;
        margin: 0;
    }
    
    .chat-header {
        padding: 1rem 1.5rem;
    }
    
    .chat-messages {
        padding: 1.5rem 1rem;
    }
    
    .chat-input {
        padding: 1rem 1.5rem;
    }
    
    .message-content {
        max-width: 85%;
        padding: 0.875rem 1rem;
    }
    
    .chat-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
}

@media (max-width: 480px) {
    .chat-header {
        padding: 0.875rem 1rem;
    }
    
    .chat-user-info h6 {
        font-size: 1rem;
    }
    
    .online-status {
        padding: 0.375rem 0.75rem;
    }
    
    .message-content {
        max-width: 90%;
        padding: 0.75rem 1rem;
    }
}

/* Scrollbar Styling */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.05);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(0,0,0,0.3);
}
</style>

<script>
let lastMessageId = {{ messages[-1].id if messages else 0 }};
let selectedFile = null;

// Auto-scroll to bottom
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Enhanced file selection with better preview
function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        // File size validation (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB');
            input.value = '';
            return;
        }
        
        selectedFile = file;
        const preview = document.getElementById('filePreview');
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        
        if (file.type.startsWith('image/')) {
            preview.innerHTML = `
                <div class="d-flex align-items-center gap-3">
                    <img src="${URL.createObjectURL(file)}" alt="Preview" style="width: 80px; height: 80px; object-fit: cover; border-radius: 12px; border: 2px solid rgba(255,255,255,0.8);">
                    <div class="flex-grow-1">
                        <div class="fw-semibold text-dark">${file.name}</div>
                        <div class="text-muted small">${fileSize} MB • Image</div>
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="clearFileSelection()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        } else if (file.type.startsWith('video/')) {
            preview.innerHTML = `
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; color: white;">
                        <i class="fas fa-video fa-2x"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold text-dark">${file.name}</div>
                        <div class="text-muted small">${fileSize} MB • Video</div>
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="clearFileSelection()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        } else {
            const fileIcon = getFileIcon(file.type);
            preview.innerHTML = `
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background: linear-gradient(135deg, #6b7280, #4b5563); border-radius: 12px; color: white;">
                        <i class="${fileIcon} fa-2x"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold text-dark">${file.name}</div>
                        <div class="text-muted small">${fileSize} MB • Document</div>
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="clearFileSelection()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }
        preview.style.display = 'block';
        
        // Update input group state
        document.querySelector('.input-group').classList.add('has-content');
    }
}

// Get appropriate file icon
function getFileIcon(fileType) {
    if (fileType.includes('pdf')) return 'fas fa-file-pdf';
    if (fileType.includes('word')) return 'fas fa-file-word';
    if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel';
    if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'fas fa-file-powerpoint';
    if (fileType.includes('zip') || fileType.includes('rar')) return 'fas fa-file-archive';
    return 'fas fa-file';
}

// Clear file selection with animation
function clearFileSelection() {
    const preview = document.getElementById('filePreview');
    preview.style.animation = 'slideDown 0.3s ease';
    
    setTimeout(() => {
        selectedFile = null;
        document.getElementById('fileInput').value = '';
        preview.style.display = 'none';
        preview.style.animation = '';
        
        // Update input group state
        const messageInput = document.getElementById('messageInput');
        if (!messageInput.value.trim()) {
            document.querySelector('.input-group').classList.remove('has-content');
        }
    }, 300);
}



// Send message
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    const sendButton = document.getElementById('sendButton');
    
    if (!message && !selectedFile) {
        alert('Please enter a message or select a file');
        return;
    }
    
    // Disable send button to prevent double sending
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    const formData = new FormData();
    if (message) formData.append('message', message);
    if (selectedFile) formData.append('file', selectedFile);
    
    // Add CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]');
    if (csrfToken) {
        formData.append('csrf_token', csrfToken.value);
        console.log('CSRF token added:', csrfToken.value.substring(0, 10) + '...');
    } else {
        console.error('CSRF token not found!');
    }
    
    console.log('Sending message to:', `/chat/{{ room.id }}/send`);
    
    fetch(`/chat/{{ room.id }}/send`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            messageInput.value = '';
            clearFileSelection();
            
            // Immediately add the message to the chat
            setTimeout(() => {
                loadNewMessages();
            }, 100);
            
            // Update message status if provided
            if (data.message_id && data.status) {
                setTimeout(() => {
                    updateMessageStatus(data.message_id, data.status);
                }, 500);
            }
        } else {
            console.error('Send message failed:', data);
            alert('Failed to send message: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    })
    .finally(() => {
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    });
});

// Load new messages
function loadNewMessages() {
    console.log('Loading new messages since:', lastMessageId);
    fetch(`/chat/{{ room.id }}/messages?since=${lastMessageId}`)
    .then(response => {
        console.log('Messages response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Messages data:', data);
        const chatMessages = document.getElementById('chatMessages');
        
        if (data.messages && data.messages.length > 0) {
            console.log('Adding', data.messages.length, 'new messages');
        }
        
        data.messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.is_own ? 'message-own' : 'message-other'}`;
            messageDiv.setAttribute('data-message-id', msg.id);
            
            let content = '';
            if (msg.message_type === 'image') {
                content = `
                    <div class="message-media">
                        <img src="/static/${msg.file_path}" alt="Shared image" class="chat-image" onclick="openImageModal('/static/${msg.file_path}')">
                        ${msg.content ? `<p class="mt-2 mb-1">${msg.content}</p>` : ''}
                    </div>
                `;
            } else if (msg.message_type === 'video') {
                content = `
                    <div class="message-media">
                        <video controls class="chat-video">
                            <source src="/static/${msg.file_path}" type="video/mp4">
                        </video>
                        ${msg.content ? `<p class="mt-2 mb-1">${msg.content}</p>` : ''}
                    </div>
                `;
            } else if (msg.message_type === 'file') {
                content = `
                    <div class="message-file">
                        <i class="fas fa-file me-2"></i>
                        <a href="/static/${msg.file_path}" target="_blank">${msg.file_name}</a>
                        ${msg.content ? `<p class="mt-2 mb-1">${msg.content}</p>` : ''}
                    </div>
                `;
            } else {
                // Default to text message
                content = `<p class="mb-1">${msg.content || ''}</p>`;
            }
            
            let statusIcon = '';
            if (msg.is_own) {
                if (msg.status === 'sent') {
                    statusIcon = `<span class="message-status" data-status="sent"><i class="fas fa-check status-sent" title="Sent"></i></span>`;
                } else if (msg.status === 'delivered') {
                    statusIcon = `<span class="message-status" data-status="delivered"><i class="fas fa-check-double status-delivered" title="Delivered"></i></span>`;
                } else if (msg.status === 'seen') {
                    statusIcon = `<span class="message-status" data-status="seen"><i class="fas fa-check-double status-seen" title="Seen"></i></span>`;
                }
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${content}
                    <div class="message-meta">
                        ${statusIcon}
                    </div>
                </div>
            `;
            

            
            chatMessages.appendChild(messageDiv);
            lastMessageId = Math.max(lastMessageId, msg.id);
        });
        
        if (data.messages.length > 0) {
            scrollToBottom();
        }
    })
    .catch(error => console.error('Error:', error));
}

// Open image modal
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

// Enhanced input handling with typing indicators
const messageInput = document.getElementById('messageInput');
const inputGroup = document.querySelector('.input-group');
const sendButton = document.getElementById('sendButton');

// Typing indicator
messageInput.addEventListener('input', function() {
    const hasContent = this.value.trim().length > 0;
    
    if (hasContent) {
        inputGroup.classList.add('has-content');
        sendButton.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    } else {
        inputGroup.classList.remove('has-content');
        sendButton.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
    }
});

// Focus effects
messageInput.addEventListener('focus', function() {
    inputGroup.classList.add('typing');
});

messageInput.addEventListener('blur', function() {
    inputGroup.classList.remove('typing');
});

// Enter key to send
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (this.value.trim() || selectedFile) {
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }
    }
});

// Mark messages as seen when user is viewing the chat
function markMessagesAsSeen() {
    fetch(`/api/chat/{{ room.id }}/mark-seen`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.marked_count > 0) {
            // Update status of other user's messages that were just marked as seen
            // This will be handled by the periodic message refresh
            loadNewMessages();
        }
    })
    .catch(error => console.error('Error marking messages as seen:', error));
}

// Update message status in real-time
function updateMessageStatus(messageId, status) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
        const statusElement = messageElement.querySelector('.message-status');
        if (statusElement) {
            const icon = statusElement.querySelector('i');
            icon.className = 'fas ';
            
            if (status === 'sent') {
                icon.className += 'fa-check status-sent';
                icon.title = 'Sent';
            } else if (status === 'delivered') {
                icon.className += 'fa-check-double status-delivered';
                icon.title = 'Delivered';
            } else if (status === 'seen') {
                icon.className += 'fa-check-double status-seen';
                icon.title = 'Seen';
            }
            
            statusElement.setAttribute('data-status', status);
        }
    }
}

// Mark messages as seen when page loads and when user focuses on window
markMessagesAsSeen();
window.addEventListener('focus', markMessagesAsSeen);

// Poll for new messages every 3 seconds
setInterval(loadNewMessages, 3000);



// Clear chat history function
function clearChatHistory() {
    if (confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
        fetch(`/api/chat/{{ room.id }}/clear`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('chatMessages').innerHTML = '';
                alert('Chat history cleared successfully!');
            } else {
                alert('Failed to clear chat history: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to clear chat history. Please try again.');
        });
    }
}

// Initial scroll to bottom
scrollToBottom();

// Check user online status
function checkUserStatus() {
    const otherUserId = {% if current_user.is_admin %}{{ room.user.id }}{% else %}{{ room.admin.id }}{% endif %};
    
    fetch(`/api/user/${otherUserId}/status`)
    .then(response => response.json())
    .then(data => {
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const userStatus = document.getElementById('userStatus');
        
        if (data.is_online) {
            statusIcon.style.color = '#16a34a';
            statusText.textContent = 'Online';
            userStatus.style.background = '#f0fdf4';
            userStatus.style.borderColor = '#bbf7d0';
            userStatus.classList.remove('offline');
        } else {
            statusIcon.style.color = '#9ca3af';
            statusText.textContent = `Last seen ${data.last_seen}`;
            userStatus.style.background = '#f9fafb';
            userStatus.style.borderColor = '#e5e7eb';
            userStatus.classList.add('offline');
        }
    })
    .catch(error => {
        console.error('Error checking user status:', error);
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const userStatus = document.getElementById('userStatus');
        statusIcon.style.color = '#9ca3af';
        statusText.textContent = 'Offline';
        userStatus.style.background = '#f9fafb';
        userStatus.style.borderColor = '#e5e7eb';
        userStatus.classList.add('offline');
    });
}

// Update own activity
function updateActivity() {
    fetch('/api/user/update-activity', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    }).catch(error => console.error('Error updating activity:', error));
}

// Check status on load and every 30 seconds
checkUserStatus();
setInterval(checkUserStatus, 30000);

// Update activity every 2 minutes
setInterval(updateActivity, 120000);

// Update activity on user interaction
document.addEventListener('click', updateActivity);
document.addEventListener('keypress', updateActivity);
</script>
{% endblock %}