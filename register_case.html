{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    <i class="fas fa-user-plus me-2"></i>Register Missing Person
                </h1>
                <p class="lead text-muted">Help us find your loved one using AI-powered face recognition</p>
            </div>

            <!-- Form Card -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data" id="registrationForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Personal Information -->
                        <div class="mb-4">
                            <h4 class="text-primary mb-3">
                                <i class="fas fa-user me-2"></i>Personal Information
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.full_name.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.full_name(class="form-control" + (" is-invalid" if form.full_name.errors else ""), placeholder="Enter full legal name") }}
                                    {% if form.full_name.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.full_name.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">{{ form.nickname.label.text }}</label>
                                    {{ form.nickname(class="form-control", placeholder="Known as, goes by") }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.age.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.age(class="form-control" + (" is-invalid" if form.age.errors else ""), min="0", max="120", placeholder="Age in years") }}
                                    {% if form.age.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.age.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.gender.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.gender(class="form-select" + (" is-invalid" if form.gender.errors else "")) }}
                                    {% if form.gender.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.gender.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Physical Characteristics -->
                        <div class="mb-4">
                            <h4 class="text-primary mb-3">
                                <i class="fas fa-ruler me-2"></i>Physical Characteristics
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.height_cm.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.height_cm(class="form-control" + (" is-invalid" if form.height_cm.errors else ""), min="30", max="250", placeholder="Height in centimeters") }}
                                    {% if form.height_cm.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.height_cm.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    {{ form.distinguishing_marks.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ form.distinguishing_marks(class="form-control" + (" is-invalid" if form.distinguishing_marks.errors else ""), rows="3", placeholder="Describe any scars, tattoos, birthmarks, or unique features") }}
                                {% if form.distinguishing_marks.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.distinguishing_marks.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Contact Information -->
                        <div class="mb-4">
                            <h4 class="text-primary mb-3">
                                <i class="fas fa-phone me-2"></i>Your Contact Information
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.contact_person_name.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.contact_person_name(class="form-control" + (" is-invalid" if form.contact_person_name.errors else ""), placeholder="Your full name") }}
                                    {% if form.contact_person_name.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.contact_person_name.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.contact_person_phone.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.contact_person_phone(class="form-control" + (" is-invalid" if form.contact_person_phone.errors else ""), placeholder="+1234567890", type="tel") }}
                                    {% if form.contact_person_phone.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.contact_person_phone.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    {{ form.contact_person_email.label.text }} <span class="text-danger">*</span>
                                </label>
                                {{ form.contact_person_email(class="form-control" + (" is-invalid" if form.contact_person_email.errors else ""), placeholder="your.email@example.com", type="email") }}
                                {% if form.contact_person_email.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.contact_person_email.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Contact Address</label>
                                <textarea class="form-control" name="contact_address" rows="2" placeholder="Your complete address for contact purposes"></textarea>
                                <small class="text-muted">This helps us contact you if needed</small>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Case Details -->
                        <div class="mb-4">
                            <h4 class="text-primary mb-3">
                                <i class="fas fa-calendar-alt me-2"></i>Case Details
                            </h4>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.last_seen_date.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.last_seen_date(class="form-control" + (" is-invalid" if form.last_seen_date.errors else ""), type="date") }}
                                    {% if form.last_seen_date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.last_seen_date.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-semibold">Last Seen Time (Optional)</label>
                                    <input type="time" class="form-control" name="last_seen_time" placeholder="HH:MM">
                                    <small class="text-muted">If you remember the approximate time</small>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-semibold">
                                        {{ form.last_seen_location.label.text }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.last_seen_location(class="form-control" + (" is-invalid" if form.last_seen_location.errors else ""), placeholder="Street address, city, landmarks") }}
                                    {% if form.last_seen_location.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.last_seen_location.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">{{ form.additional_info.label.text }}</label>
                                {{ form.additional_info(class="form-control", rows="4", placeholder="Circumstances of disappearance, clothing style, medical conditions, behavioral patterns, or any other relevant information. Even optional details can be very important for AI analysis - please don't skip anything that might help.") }}
                                <small class="text-info"><i class="fas fa-info-circle"></i> <strong>Important:</strong> Include clothing style, habits, and any detail that might seem minor - AI uses all information for better matching.</small>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Photos & Media -->
                        <div class="mb-4">
                            <h4 class="text-primary mb-3">
                                <i class="fas fa-camera me-2"></i>Photos & Media
                            </h4>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    {{ form.photos.label.text }} <span class="text-danger">*</span>
                                </label>
                                <div class="border border-2 border-dashed rounded p-4 text-center" style="cursor: pointer; border-color: #dee2e6 !important;" onclick="document.getElementById('photos').click()">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="mb-2 fw-semibold">Click to upload photos</p>
                                    <p class="text-muted small mb-0">JPG, PNG files up to 10MB each</p>
                                    {{ form.photos(class="d-none", id="photos", multiple=true, accept="image/*") }}
                                </div>
                                <div id="image-preview" class="mt-3"></div>
                                {% if form.photos.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.photos.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold">{{ form.video.label.text }} (Optional)</label>
                                <div class="border border-2 border-dashed rounded p-4 text-center" style="cursor: pointer; border-color: #dee2e6 !important;" onclick="document.getElementById('video').click()">
                                    <i class="fas fa-video fa-2x text-muted mb-2"></i>
                                    <p class="mb-1 fw-semibold">Upload close look video of missing person</p>
                                    <p class="text-muted small mb-0">For better analysis of body and facial structure - MP4, AVI, MOV up to 50MB</p>
                                    {{ form.video(class="d-none", id="video", accept="video/*") }}
                                </div>
                                <small class="text-info"><i class="fas fa-info-circle"></i> <strong>Note:</strong> Video helps AI analyze body language and facial features for better matching.</small>
                                {% if form.video.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.video.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="text-center pt-3">
                            {{ form.submit(class="btn btn-primary btn-lg px-5") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const imagePreview = document.getElementById('image-preview');
    let selectedFiles = [];
    
    // Handle photo uploads
    document.getElementById('photos').addEventListener('change', function(e) {
        selectedFiles = Array.from(e.target.files).filter(f => f.type.match('image.*'));
        displayImagePreviews();
    });
    
    function displayImagePreviews() {
        imagePreview.innerHTML = '';
        if (selectedFiles.length > 0) {
            imagePreview.className = 'd-flex flex-wrap gap-2';
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'position-relative';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" class="rounded" style="width: 100px; height: 100px; object-fit: cover;">
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 rounded-circle" style="width: 25px; height: 25px; padding: 0; transform: translate(50%, -50%);" onclick="removeImage(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    imagePreview.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        }
    }
    
    window.removeImage = function(index) {
        selectedFiles.splice(index, 1);
        updateFileInput();
        displayImagePreviews();
        
        // Show warning if no images left
        if (selectedFiles.length === 0) {
            imagePreview.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> At least one photo is required for AI analysis.</div>';
        }
    };
    
    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        document.getElementById('photos').files = dt.files;
    }
    
    // Handle video upload display with validation
    document.getElementById('video').addEventListener('change', function(e) {
        const uploadDiv = this.closest('.border');
        const textP = uploadDiv.querySelector('p.fw-semibold');
        const smallText = uploadDiv.querySelector('p.small');
        
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            const fileSize = file.size / (1024 * 1024); // Convert to MB
            
            // Validate file size (50MB limit)
            if (fileSize > 50) {
                alert('Video file is too large. Please select a file smaller than 50MB.');
                this.value = '';
                textP.textContent = 'Upload close look video of missing person';
                smallText.textContent = 'For better analysis of body and facial structure - MP4, AVI, MOV up to 50MB';
                return;
            }
            
            // Validate file type
            const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime', 'video/x-msvideo'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid video file (MP4, AVI, or MOV).');
                this.value = '';
                textP.textContent = 'Upload close look video of missing person';
                smallText.textContent = 'For better analysis of body and facial structure - MP4, AVI, MOV up to 50MB';
                return;
            }
            
            textP.textContent = `Selected: ${file.name} (${fileSize.toFixed(1)} MB)`;
            smallText.innerHTML = '<i class="fas fa-check-circle text-success"></i> Video ready for upload - Admin will verify before AI processing';
        }
    });
    
    // Form submission with validation and duplicate prevention
    let formSubmitted = false;
    document.getElementById('registrationForm').addEventListener('submit', function(e) {
        // Prevent duplicate submissions
        if (formSubmitted) {
            e.preventDefault();
            return false;
        }
        
        const submitBtn = this.querySelector('button[type="submit"]');
        const photoInput = document.getElementById('photos');
        
        // Validate at least one photo is selected
        if (!photoInput.files || photoInput.files.length === 0) {
            e.preventDefault();
            alert('Please upload at least one photo of the missing person for AI analysis.');
            return false;
        }
        
        // Mark form as submitted and disable button
        formSubmitted = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    });
    
    // Reset form submission flag on page load (for back button)
    window.addEventListener('pageshow', function() {
        formSubmitted = false;
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Case';
        }
    });
});
</script>
{% endblock %}