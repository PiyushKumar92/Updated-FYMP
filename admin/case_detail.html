{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Case Details: {{ case.person_name }}</h2>
        <a href="{{ url_for('admin.cases') }}" class="btn btn-secondary">Back to Cases</a>
    </div>
    
    <!-- Missing Person Photos -->
    {% if case.target_images %}
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-images me-2"></i>Missing Person Photos ({{ case.target_images|length }})</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for image in case.target_images %}
                <div class="col-md-3 mb-3">
                    <div class="card">
                        {% set img_path = image.image_path.replace('static/', '') if image.image_path.startswith('static/') else image.image_path %}
                        <img src="{{ url_for('static', filename=img_path) }}" 
                             class="card-img-top" 
                             alt="{{ case.person_name }}" 
                             style="height: 200px; object-fit: cover; cursor: pointer;"
                             onclick="openImageModal('{{ url_for('static', filename=img_path) }}')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display:none; height: 200px; background: #f3f4f6; border: 2px dashed #d1d5db; align-items: center; justify-content: center; color: #9ca3af;">
                            <i class="fas fa-image fa-3x"></i>
                        </div>
                        <div class="card-body p-2">
                            <small class="text-muted">Photo {{ loop.index }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Missing Person Videos -->
    {% if case.search_videos %}
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-video me-2"></i>Reference Videos ({{ case.search_videos|length }})</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for video in case.search_videos %}
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">{{ video.video_name or 'Video ' + loop.index|string }}</h6>
                            {% set vid_path = video.video_path.replace('static/', '') if video.video_path.startswith('static/') else video.video_path %}
                            <video controls class="w-100" style="max-height: 300px;" preload="metadata">
                                <source src="{{ url_for('static', filename=vid_path) }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle me-2"></i>Case Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Case ID:</strong> {{ case.id }}</p>
                    <p><strong>Person Name:</strong> {{ case.person_name }}</p>
                    <p><strong>Age:</strong> {{ case.age or 'Unknown' }}</p>
                    <p><strong>Status:</strong> 
                        <span class="badge 
                            {% if case.status == 'Pending Approval' %}bg-info
                            {% elif case.status == 'Queued' %}bg-secondary
                            {% elif case.status == 'Processing' %}bg-warning
                            {% elif case.status == 'Completed' %}bg-success
                            {% elif case.status == 'Rejected' %}bg-danger
                            {% elif case.status == 'Error' %}bg-danger
                            {% endif %}">
                            {{ case.status }}
                        </span>
                    </p>
                    <p><strong>Priority:</strong> 
                        <span class="badge {% if case.priority == 'High' %}bg-danger{% elif case.priority == 'Medium' %}bg-warning{% else %}bg-info{% endif %}">
                            {{ case.priority }}
                        </span>
                    </p>
                    <p><strong>Created by:</strong> {{ case.creator.username }}</p>
                    <p><strong>Created:</strong> {{ case.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    {% if case.completed_at %}
                    <p><strong>Completed:</strong> {{ case.completed_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    {% endif %}
                    <p><strong>Last Seen Location:</strong> 
                        <i class="fas fa-map-marker-alt text-danger me-1"></i>
                        {{ case.last_seen_location or 'Unknown' }}
                    </p>
                    {% if case.date_missing %}
                    <p><strong>Date Missing:</strong> {{ case.date_missing.strftime('%B %d, %Y') }}</p>
                    {% endif %}
                    {% if case.last_seen_time %}
                    <p><strong>Last Seen Time:</strong> {{ case.last_seen_time.strftime('%I:%M %p') }}</p>
                    {% endif %}
                    {% if case.contact_address %}
                    <p><strong>Contact Address:</strong> {{ case.contact_address }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Statistics</h5>
                </div>
                <div class="card-body">
                    <p><strong>Target Images:</strong> {{ case.target_images|length }}</p>
                    <p><strong>Search Videos:</strong> {{ case.search_videos|length }}</p>
                    <p><strong>Total Sightings:</strong> {{ case.total_sightings }}</p>
                    <p><strong>High Confidence Sightings:</strong> {{ case.high_confidence_sightings }}</p>
                </div>
            </div>
        </div>
    </div>
    
    {% if case.details %}
    <div class="card mt-4">
        <div class="card-header">
            <h5><i class="fas fa-info-circle me-2"></i>Additional Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% set details_lines = case.details.split('\n') %}
                {% for line in details_lines %}
                    {% if ':' in line %}
                        {% set key, value = line.split(':', 1) %}
                        <div class="col-md-6 mb-2">
                            <strong class="text-primary">{{ key.strip() }}:</strong>
                            <span class="ms-2">{{ value.strip() }}</span>
                        </div>
                    {% else %}
                        <div class="col-12 mb-2">
                            <span>{{ line.strip() }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if case.clothing_description %}
    <div class="card mt-4">
        <div class="card-header">
            <h5>Clothing Description</h5>
        </div>
        <div class="card-body">
            <p>{{ case.clothing_description }}</p>
        </div>
    </div>
    {% endif %}
    
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>Processing Logs</h5>
        </div>
        <div class="card-body">
            {% if logs %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>{{ log.action }}</td>
                            <td>{{ log.details }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No processing logs available.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Admin Actions -->
    <div class="card mt-4">
        <div class="card-header">
            <h5><i class="fas fa-cogs me-2"></i>Admin Actions</h5>
        </div>
        <div class="card-body">
            {% if case.status == 'Pending Approval' %}
            <div class="alert alert-info">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Review Required:</strong> This case is pending your approval. Please review all photos, videos, and information before approving.
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <form method="POST" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" formaction="{{ url_for('admin.approve_case', case_id=case.id) }}" 
                                class="btn btn-success btn-lg w-100" 
                                onclick="return confirm('✅ Approve this case and start AI processing?')">
                            <i class="fas fa-check me-2"></i>Approve Case
                        </button>
                    </form>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-danger btn-lg w-100" data-bs-toggle="modal" data-bs-target="#rejectModal">
                        <i class="fas fa-times me-2"></i>Reject Case
                    </button>
                </div>
            </div>
            {% endif %}
            
            <div class="mt-3">
                {% if case.status in ['Error', 'Completed'] %}
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" formaction="{{ url_for('admin.requeue_case', case_id=case.id) }}" 
                            class="btn btn-warning me-2">Re-queue for Processing</button>
                </form>
                {% endif %}
                
                <form method="POST" style="display: inline;" onsubmit="return confirm('⚠️ Are you sure you want to delete this case permanently? This action cannot be undone!')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="confirm_delete" value="1">
                    <button type="submit" formaction="{{ url_for('admin.delete_case', case_id=case.id) }}" 
                            class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Case Permanently
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reject Case</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('admin.reject_case', case_id=case.id) }}">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="rejection_reason" class="form-label">Reason for Rejection:</label>
                            <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="4" required 
                                      placeholder="Please provide a clear reason for rejection..."></textarea>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            The user will be notified about the rejection and can resubmit the case.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reject Case</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ case.person_name }} - Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" alt="Full size photo">
            </div>
        </div>
    </div>
</div>

<script>
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}
</script>
{% endblock %}