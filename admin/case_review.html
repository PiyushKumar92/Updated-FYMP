{% extends "base.html" %}

{% block title %}Case Review - {{ case.person_name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Case Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-search text-primary"></i> Case Review</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('admin.cases') }}">Cases</a></li>
                            <li class="breadcrumb-item active">Review Case #{{ case.id }}</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a href="{{ url_for('admin.cases') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Cases
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Status Alert -->
    <div class="row mb-4">
        <div class="col-12">
            {% if case.status == 'Pending Approval' %}
                <div class="alert alert-warning">
                    <i class="fas fa-clock"></i> <strong>Pending Approval:</strong> This case is waiting for admin review and approval.
                </div>
            {% elif case.status == 'Approved' %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <strong>Approved:</strong> This case has been approved and is ready for AI processing.
                </div>
            {% elif case.status == 'Processing' %}
                <div class="alert alert-info">
                    <i class="fas fa-cog fa-spin"></i> <strong>Processing:</strong> AI analysis is currently in progress.
                </div>
            {% elif case.status == 'Rejected' %}
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i> <strong>Rejected:</strong> This case has been rejected and requires revision.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Case Details -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user"></i> Case Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Person Name:</strong> {{ case.person_name }}</p>
                            <p><strong>Age:</strong> {{ case.age or 'Unknown' }}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge badge-{{ 'warning' if case.status == 'Pending Approval' else 'success' if case.status == 'Approved' else 'info' if case.status == 'Processing' else 'danger' }}">
                                    {{ case.status }}
                                </span>
                            </p>
                            <p><strong>Priority:</strong> 
                                <span class="badge badge-{{ 'danger' if case.priority == 'High' else 'warning' if case.priority == 'Medium' else 'secondary' }}">
                                    {{ case.priority }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Last Seen Location:</strong> {{ case.last_seen_location or 'Not specified' }}</p>
                            <p><strong>Date Missing:</strong> {{ case.date_missing.strftime('%d %b %Y') if case.date_missing else 'Not specified' }}</p>
                            <p><strong>Submitted By:</strong> {{ case.creator.username }}</p>
                            <p><strong>Submitted On:</strong> {{ case.created_at.strftime('%d %b %Y %H:%M') }}</p>
                        </div>
                    </div>
                    
                    {% if case.details %}
                    <div class="mt-3">
                        <strong>Additional Details:</strong>
                        <div class="bg-light p-3 rounded mt-2">
                            {{ case.details | replace('\n', '<br>') | safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Case Images -->
            {% if case.target_images %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-images"></i> Submitted Photos</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for image in case.target_images %}
                        <div class="col-md-4 mb-3">
                            <img src="{{ url_for('static', filename=image.image_path) }}" 
                                 class="img-fluid rounded shadow-sm" 
                                 alt="Case Image"
                                 style="max-height: 200px; width: 100%; object-fit: cover;">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Approval Actions -->
            {% if case.status == 'Pending Approval' %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-gavel"></i> Approval Actions</h5>
                </div>
                <div class="card-body">
                    {% if can_approve %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>Ready for Approval:</strong> 
                            Found {{ nearby_footage|length }} CCTV footage files for this location.
                        </div>
                        
                        <form method="POST" action="{{ url_for('admin.approve_case', case_id=case.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-success btn-lg mr-3">
                                <i class="fas fa-check"></i> Approve Case
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Cannot Approve:</strong> 
                            No CCTV footage available for location "{{ case.last_seen_location }}". 
                            Please upload relevant footage first.
                        </div>
                        
                        <a href="{{ url_for('admin.upload_surveillance_footage') }}" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Upload Footage
                        </a>
                    {% endif %}
                    
                    <!-- Reject Button -->
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#rejectModal">
                        <i class="fas fa-times"></i> Reject Case
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Nearby Footage -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-video"></i> Available CCTV Footage</h5>
                    <span class="badge badge-light">{{ nearby_footage|length }} files</span>
                </div>
                <div class="card-body">
                    {% if nearby_footage %}
                        <div class="row">
                            {% for footage in nearby_footage %}
                            <div class="col-12 mb-3">
                                <div class="card border-left-primary">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ footage.title }}</h6>
                                                <p class="text-muted mb-1">
                                                    <i class="fas fa-map-marker-alt"></i> {{ footage.location_name }}
                                                </p>
                                                <small class="text-muted">
                                                    <i class="fas fa-clock"></i> {{ footage.formatted_duration }} | 
                                                    <i class="fas fa-hdd"></i> {{ footage.formatted_file_size }} |
                                                    <i class="fas fa-video"></i> {{ footage.quality }}
                                                    {% if footage.distance_km %}
                                                    | <i class="fas fa-route"></i> {{ "%.1f"|format(footage.distance_km) }} km
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <div class="ml-3">
                                                {% if case.status in ['Approved', 'Processing'] %}
                                                <button class="btn btn-sm btn-primary analyze-footage-btn" 
                                                        data-case-id="{{ case.id }}" 
                                                        data-footage-id="{{ footage.id }}"
                                                        data-footage-title="{{ footage.title }}">
                                                    <i class="fas fa-search"></i> Analyze
                                                </button>
                                                {% else %}
                                                <span class="text-muted small">Approve first</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if case.status in ['Approved', 'Processing'] %}
                        <div class="text-center mt-3">
                            <button class="btn btn-success btn-lg start-analysis-btn" data-case-id="{{ case.id }}">
                                <i class="fas fa-play"></i> Start AI Analysis for All Footage
                            </button>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-video-slash fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No CCTV Footage Available</h5>
                            <p class="text-muted">No surveillance footage found for location "{{ case.last_seen_location or 'this location' }}"</p>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Required:</strong> Upload CCTV footage for this location before approving the case.
                            </div>
                            <a href="{{ url_for('admin.upload_surveillance_footage') }}" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload Footage for This Location
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Existing Analysis Results -->
            {% if location_matches %}
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Analysis Results</h5>
                </div>
                <div class="card-body">
                    {% for match in location_matches %}
                    <div class="mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ match.footage.title }}</h6>
                                <p class="text-muted mb-1">
                                    Match Score: {{ "%.2f"|format(match.match_score) }} | 
                                    Status: <span class="badge badge-{{ 'success' if match.status == 'completed' else 'warning' if match.status == 'processing' else 'secondary' }}">
                                        {{ match.status.title() }}
                                    </span>
                                </p>
                                {% if match.person_found %}
                                <p class="text-success mb-0">
                                    <i class="fas fa-check-circle"></i> Person detected! 
                                    ({{ match.detection_count }} detections, 
                                    {{ "%.1f"|format(match.confidence_score * 100) }}% confidence)
                                </p>
                                {% endif %}
                            </div>
                            <div>
                                <a href="{{ url_for('admin.ai_analysis_detail', match_id=match.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Reject Case Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Case</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('admin.reject_case', case_id=case.id) }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="rejection_reason">Reason for Rejection:</label>
                        <textarea class="form-control" id="rejection_reason" name="rejection_reason" 
                                  rows="4" required placeholder="Please provide a clear reason for rejecting this case..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times"></i> Reject Case
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Handle individual footage analysis
    $('.analyze-footage-btn').click(function() {
        const caseId = $(this).data('case-id');
        const footageId = $(this).data('footage-id');
        const footageTitle = $(this).data('footage-title');
        const btn = $(this);
        
        if (confirm(`Start AI analysis for "${footageTitle}"?`)) {
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');
            
            $.post(`/admin/analyze-footage/${caseId}/${footageId}`)
                .done(function(response) {
                    if (response.success) {
                        btn.removeClass('btn-primary').addClass('btn-success')
                           .html('<i class="fas fa-check"></i> Started');
                        showAlert('success', response.message);
                    } else {
                        btn.prop('disabled', false).html('<i class="fas fa-search"></i> Analyze');
                        showAlert('danger', response.error);
                    }
                })
                .fail(function() {
                    btn.prop('disabled', false).html('<i class="fas fa-search"></i> Analyze');
                    showAlert('danger', 'Failed to start analysis');
                });
        }
    });
    
    // Handle bulk analysis
    $('.start-analysis-btn').click(function() {
        const caseId = $(this).data('case-id');
        const btn = $(this);
        
        if (confirm('Start AI analysis for all available footage?')) {
            btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting Analysis...');
            
            $.post(`/admin/cases/${caseId}/start-analysis`)
                .done(function(response) {
                    if (response.success) {
                        btn.removeClass('btn-success').addClass('btn-info')
                           .html('<i class="fas fa-check"></i> Analysis Started');
                        showAlert('success', response.message);
                        
                        // Refresh page after 2 seconds
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        btn.prop('disabled', false).html('<i class="fas fa-play"></i> Start AI Analysis for All Footage');
                        showAlert('danger', response.error);
                    }
                })
                .fail(function() {
                    btn.prop('disabled', false).html('<i class="fas fa-play"></i> Start AI Analysis for All Footage');
                    showAlert('danger', 'Failed to start analysis');
                });
        }
    });
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `;
        $('.container-fluid').prepend(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }
});
</script>
{% endblock %}